<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>개념 가챠 - 몰랐던 것 인출기</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#6366f1",
                        "background-light": "#f8fafc",
                        "background-dark": "#0f172a",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1e293b",
                    },
                    fontFamily: {
                        display: ["'Noto Sans KR'", "sans-serif"],
                        body: ["'Inter'", "sans-serif"],
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(99, 102, 241, 0.5)',
                        'glow-intense': '0 0 60px rgba(239, 68, 68, 0.6)',
                        'card-depth': '0 25px 50px -12px rgba(0, 0, 0, 0.15), 0 10px 20px -5px rgba(0, 0, 0, 0.08)',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                },
            },
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;family=Noto+Sans+KR:wght@400;500;700;900&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .korean-text { font-family: 'Noto Sans KR', sans-serif; }
        .view { display: none; }
        .view.active { display: flex; }
        .screen { display: none !important; }
        .screen.active { display: flex !important; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-800 dark:text-slate-200 h-screen flex overflow-hidden transition-colors duration-300">

<!-- ========== 학생 선택 화면 ========== -->
<div class="screen active fixed inset-0 z-50 items-center justify-center bg-background-light dark:bg-background-dark p-6" id="studentSelectScreen">
    <div class="w-full max-w-md">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-600 korean-text mb-3">개념 가챠</h1>
            <p class="text-slate-500 dark:text-slate-400 korean-text">학생을 선택하거나 새로 등록하세요</p>
        </div>

        <div class="bg-white dark:bg-slate-800 rounded-3xl p-8 shadow-card-depth border border-slate-100 dark:border-slate-700">
            <!-- 학생 목록 -->
            <div class="mb-6">
                <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 korean-text mb-4">등록된 학생</h3>
                <div class="space-y-3 max-h-64 overflow-y-auto" id="studentList">
                    <div class="text-center text-slate-400 py-4 korean-text">로딩 중...</div>
                </div>
            </div>

            <!-- 구분선 -->
            <div class="relative my-8">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-slate-200 dark:border-slate-700"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-4 bg-white dark:bg-slate-800 text-slate-400 korean-text">또는</span>
                </div>
            </div>

            <!-- 새 학생 추가 -->
            <div>
                <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 korean-text mb-4">새 학생 등록</h3>
                <div class="flex gap-3">
                    <input type="text" class="flex-1 p-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-white korean-text focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="이름 입력" id="newStudentName"/>
                    <button class="px-6 py-4 rounded-xl bg-gradient-to-r from-orange-500 to-red-600 text-white font-bold korean-text hover:opacity-90 transition-all shadow-lg shadow-orange-500/25" id="addStudentBtn">
                        등록
                    </button>
                </div>
            </div>
        </div>

        <!-- 다크모드 토글 -->
        <div class="flex justify-center mt-6">
            <button class="p-3 rounded-full bg-white dark:bg-slate-800 shadow-sm border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors" onclick="document.documentElement.classList.toggle('dark')">
                <span class="material-symbols-outlined text-slate-600 dark:text-slate-300">dark_mode</span>
            </button>
        </div>
    </div>
</div>

<!-- ========== 메인 앱 ========== -->
<div class="screen w-full h-full" id="mainAppScreen">

    <!-- Sidebar -->
    <aside class="w-72 bg-surface-light dark:bg-surface-dark border-r border-slate-200 dark:border-slate-800 flex flex-col justify-between z-20 shadow-sm hidden lg:flex transition-colors duration-300">
        <div class="p-8">
            <header class="mb-8">
                <h1 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-600 korean-text tracking-tight mb-2">개념 가챠</h1>
                <p class="text-xs text-slate-500 dark:text-slate-400 korean-text font-medium leading-relaxed">
                    몰랐던 것을 기록하고,<br/>랜덤으로 꺼내서 기억하자
                </p>
            </header>

            <!-- 현재 학생 -->
            <div class="mb-8 p-4 bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20 rounded-2xl border border-orange-100 dark:border-orange-800/30">
                <div class="text-[10px] text-orange-600 dark:text-orange-400 font-bold uppercase mb-1 korean-text">현재 학생</div>
                <div class="flex items-center justify-between">
                    <span class="text-lg font-black text-slate-800 dark:text-white korean-text" id="currentStudentName">-</span>
                    <button class="text-xs text-orange-600 dark:text-orange-400 hover:underline korean-text font-bold" id="changeStudentBtn">변경</button>
                </div>
            </div>

            <nav class="space-y-4">
                <a class="nav-link flex items-center gap-4 px-5 py-4 rounded-2xl font-medium transition-all korean-text border cursor-pointer" data-view="gacha" href="#">
                    <span class="material-symbols-outlined transition-transform">style</span>
                    카드 뽑기
                </a>
                <a class="nav-link flex items-center gap-4 px-5 py-4 rounded-2xl font-medium transition-all korean-text border cursor-pointer" data-view="add" href="#">
                    <span class="material-symbols-outlined">add_circle</span>
                    카드 추가
                </a>
                <a class="nav-link flex items-center gap-4 px-5 py-4 rounded-2xl font-medium transition-all korean-text border cursor-pointer" data-view="list" href="#">
                    <span class="material-symbols-outlined">grid_view</span>
                    전체 목록
                </a>
            </nav>
        </div>
        <div class="p-8 border-t border-slate-100 dark:border-slate-800">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-5 korean-text">학습 현황</h3>
            <div class="grid grid-cols-2 gap-3">
                <div class="p-4 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm flex flex-col">
                    <div class="text-[10px] text-slate-500 korean-text mb-1 font-bold uppercase">전체 카드</div>
                    <div class="text-2xl font-black text-slate-800 dark:text-white" id="statTotal">0</div>
                </div>
                <div class="p-4 bg-red-50 dark:bg-red-900/10 rounded-xl border border-red-100 dark:border-red-900/20 shadow-sm flex flex-col">
                    <div class="text-[10px] text-red-500 korean-text mb-1 font-bold uppercase">상자 1</div>
                    <div class="text-2xl font-black text-red-600 dark:text-red-400" id="statBox1">0</div>
                </div>
                <div class="p-4 bg-yellow-50 dark:bg-yellow-900/10 rounded-xl border border-yellow-100 dark:border-yellow-900/20 shadow-sm flex flex-col">
                    <div class="text-[10px] text-yellow-600 korean-text mb-1 font-bold uppercase">상자 2</div>
                    <div class="text-2xl font-black text-yellow-600 dark:text-yellow-400" id="statBox2">0</div>
                </div>
                <div class="p-4 bg-emerald-50 dark:bg-emerald-900/10 rounded-xl border border-emerald-100 dark:border-emerald-900/20 shadow-sm flex flex-col">
                    <div class="text-[10px] text-emerald-600 korean-text mb-1 font-bold uppercase">상자 3-4</div>
                    <div class="text-2xl font-black text-emerald-600 dark:text-emerald-400" id="statBox34">0</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 relative flex flex-col items-center justify-center p-6 lg:p-12 overflow-y-auto overflow-x-hidden bg-white/40 dark:bg-[#0f172a]">

        <!-- Top Buttons -->
        <div class="absolute top-6 right-6 flex gap-3 z-30">
            <button class="lg:hidden p-3 rounded-full bg-white dark:bg-slate-800 shadow-sm border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors" id="mobileMenuBtn">
                <span class="material-symbols-outlined text-slate-600 dark:text-slate-300">menu</span>
            </button>
            <button class="p-3 rounded-full bg-white dark:bg-slate-800 shadow-sm border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors" onclick="document.documentElement.classList.toggle('dark')">
                <span class="material-symbols-outlined text-slate-600 dark:text-slate-300">dark_mode</span>
            </button>
        </div>

        <!-- Mobile: 현재 학생 표시 -->
        <div class="lg:hidden absolute top-6 left-6 z-30">
            <button class="flex items-center gap-2 px-4 py-2 rounded-full bg-white dark:bg-slate-800 shadow-sm border border-slate-200 dark:border-slate-700 korean-text text-sm font-bold" id="mobileChangeStudentBtn">
                <span class="material-symbols-outlined text-orange-500">person</span>
                <span id="mobileStudentName">-</span>
            </button>
        </div>

        <!-- ========== GACHA VIEW ========== -->
        <div class="view active w-full max-w-2xl flex flex-col items-center gap-16 relative" id="gachaView">
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-gradient-to-tr from-orange-300/20 to-rose-300/20 dark:from-orange-900/20 dark:to-rose-900/20 rounded-full blur-[100px] -z-10 pointer-events-none"></div>

            <!-- Card Display -->
            <div class="w-full relative group perspective-1000" id="cardContainer">
                <div class="relative bg-white dark:bg-slate-800 rounded-[2rem] p-10 md:p-14 shadow-card-depth border border-slate-100 dark:border-slate-700/50 flex flex-col items-center text-center transition-all duration-500 hover:shadow-2xl">
                    <div class="absolute top-8 left-8">
                        <span class="px-4 py-1.5 rounded-full bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider border border-slate-200 dark:border-slate-600 korean-text flex items-center gap-2" id="boxBadge">
                            <span class="relative flex h-2 w-2">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500" id="boxDot"></span>
                            </span>
                            <span id="boxLabel">상자 1</span>
                        </span>
                    </div>
                    <div class="mt-8 mb-10 w-full">
                        <h2 class="text-3xl md:text-5xl font-extrabold text-slate-900 dark:text-white leading-tight korean-text tracking-tight" id="cardQuestion">
                            카드를 뽑아보세요!
                        </h2>
                    </div>
                    <div class="w-full bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900 rounded-2xl p-8 border border-slate-200 dark:border-slate-700/50 mb-10 transition-all shadow-inner relative overflow-hidden group/answer hidden" id="answerBox">
                        <div class="absolute top-0 left-0 w-1 h-full bg-teal-500"></div>
                        <p class="text-2xl font-bold text-teal-700 dark:text-teal-400 korean-text" id="cardAnswer"></p>
                    </div>

                    <button class="py-4 px-8 rounded-2xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold korean-text hover:bg-slate-200 dark:hover:bg-slate-600 transition-all hidden" id="showAnswerBtn">
                        정답 보기
                    </button>

                    <div class="flex w-full gap-5 mt-auto hidden" id="feedbackBtns">
                        <button class="flex-1 py-5 rounded-2xl bg-white dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 hover:border-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 hover:text-emerald-700 dark:hover:text-emerald-400 text-slate-400 dark:text-slate-500 font-bold transition-all duration-200 hover:-translate-y-1 hover:shadow-lg flex items-center justify-center gap-2 group/btn" id="successBtn">
                            <span class="material-symbols-outlined text-2xl group-hover/btn:scale-110 transition-transform">check_circle</span>
                            <span class="text-base korean-text">알고 있었다</span>
                        </button>
                        <button class="flex-1 py-5 rounded-2xl bg-white dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 hover:border-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 hover:text-rose-700 dark:hover:text-rose-400 text-slate-400 dark:text-slate-500 font-bold transition-all duration-200 hover:-translate-y-1 hover:shadow-lg flex items-center justify-center gap-2 group/btn" id="failBtn">
                            <span class="material-symbols-outlined text-2xl group-hover/btn:scale-110 transition-transform">cancel</span>
                            <span class="text-base korean-text">몰랐다</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Gacha Button -->
            <div class="relative group cursor-pointer z-10 -mt-4">
                <div class="absolute inset-0 bg-gradient-to-r from-orange-500 to-red-600 rounded-full blur-[40px] opacity-40 group-hover:opacity-70 group-hover:blur-[50px] transition-all duration-500 animate-pulse-slow"></div>
                <button class="relative w-28 h-28 md:w-36 md:h-36 rounded-full bg-gradient-to-br from-orange-500 via-red-500 to-red-600 flex flex-col items-center justify-center shadow-glow-intense transform transition-all duration-300 group-hover:scale-105 group-active:scale-95 border-[6px] border-white/20 dark:border-white/10 ring-1 ring-orange-500/30 overflow-hidden" id="gachaBtn">
                    <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/20 to-transparent pointer-events-none"></div>
                    <span class="material-symbols-outlined text-white text-5xl md:text-6xl mb-1 drop-shadow-md z-10 transition-transform group-hover:rotate-12">style</span>
                </button>
                <div class="absolute -bottom-8 left-1/2 -translate-x-1/2 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity text-sm font-bold text-orange-600 dark:text-orange-400 korean-text">
                    카드 뽑기
                </div>
            </div>
        </div>

        <!-- ========== ADD VIEW ========== -->
        <div class="view w-full max-w-xl" id="addView">
            <div class="bg-white dark:bg-slate-800 rounded-[2rem] p-10 shadow-card-depth border border-slate-100 dark:border-slate-700/50">
                <h2 class="text-2xl font-black text-slate-900 dark:text-white korean-text mb-8">새 카드 추가</h2>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-600 dark:text-slate-400 korean-text mb-2">몰랐던 것 (질문)</label>
                        <textarea class="w-full p-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-white korean-text focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all resize-none" rows="3" placeholder="예: 광합성에서 물이 분해되면 뭐가 나와?" id="inputQuestion"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-600 dark:text-slate-400 korean-text mb-2">정답 (선택)</label>
                        <input type="text" class="w-full p-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-white korean-text focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all" placeholder="예: 산소 (O₂)" id="inputAnswer"/>
                    </div>
                    <button class="w-full py-4 rounded-xl bg-gradient-to-r from-orange-500 to-red-600 text-white font-bold korean-text hover:opacity-90 transition-all shadow-lg shadow-orange-500/25" id="addCardBtn">
                        카드 추가
                    </button>
                </div>
            </div>
        </div>

        <!-- ========== LIST VIEW ========== -->
        <div class="view w-full max-w-3xl" id="listView">
            <div class="bg-white dark:bg-slate-800 rounded-[2rem] p-10 shadow-card-depth border border-slate-100 dark:border-slate-700/50">
                <h2 class="text-2xl font-black text-slate-900 dark:text-white korean-text mb-8">전체 카드 목록</h2>
                <div class="space-y-4" id="cardList"></div>
            </div>
        </div>

    </main>
</div>

<!-- Toast -->
<div class="fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold korean-text shadow-xl opacity-0 transition-all duration-300 z-[100]" id="toast"></div>

<script>
const API = '';
let currentStudent = null;
let currentCard = null;

// ============ 학생 선택 화면 ============

async function loadStudentList() {
    const list = document.getElementById('studentList');
    try {
        const res = await fetch(`${API}/api/students`);
        const students = await res.json();

        if (students.length === 0) {
            list.innerHTML = '<div class="text-center text-slate-400 py-4 korean-text">등록된 학생이 없습니다</div>';
            return;
        }

        // 학생 데이터를 전역에 저장
        window._students = students;

        list.innerHTML = students.map((s, idx) => `
            <button class="student-select-btn w-full flex items-center justify-between p-4 rounded-xl border border-slate-200 dark:border-slate-700 hover:border-orange-500 hover:bg-orange-50 dark:hover:bg-orange-900/20 transition-all group" data-idx="${idx}">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-orange-400 to-red-500 flex items-center justify-center text-white font-bold">
                        ${s.name.charAt(0)}
                    </div>
                    <span class="font-bold text-slate-700 dark:text-slate-200 korean-text">${s.name}</span>
                </div>
                <span class="material-symbols-outlined text-slate-300 group-hover:text-orange-500 transition-colors">arrow_forward</span>
            </button>
        `).join('');

        // 이벤트 리스너 등록
        list.querySelectorAll('.student-select-btn').forEach(btn => {
            btn.onclick = function() {
                const idx = parseInt(this.dataset.idx);
                const student = window._students[idx];
                if (student) {
                    selectStudent(student.id, student.name);
                }
            };
        });
    } catch (e) {
        list.innerHTML = '<div class="text-center text-red-400 py-4 korean-text">로드 실패</div>';
    }
}

function selectStudent(id, name) {
    currentStudent = { id, name };
    localStorage.setItem('currentStudent', JSON.stringify(currentStudent));

    document.getElementById('studentSelectScreen').classList.remove('active');
    document.getElementById('mainAppScreen').classList.add('active');

    document.getElementById('currentStudentName').textContent = name;
    document.getElementById('mobileStudentName').textContent = name;

    loadStats();
}

function showStudentSelect() {
    document.getElementById('mainAppScreen').classList.remove('active');
    document.getElementById('studentSelectScreen').classList.add('active');
    loadStudentList();
}

// 새 학생 추가
document.getElementById('addStudentBtn').addEventListener('click', async () => {
    const name = document.getElementById('newStudentName').value.trim();
    if (!name) {
        showToast('이름을 입력해주세요', true);
        return;
    }

    try {
        const res = await fetch(`${API}/api/students`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });

        if (!res.ok) {
            const err = await res.json();
            showToast(err.error || '등록 실패', true);
            return;
        }

        const student = await res.json();
        document.getElementById('newStudentName').value = '';
        showToast(`${name} 학생이 등록되었습니다!`);
        selectStudent(student.id, student.name);
    } catch (e) {
        showToast('등록 실패', true);
    }
});

// 학생 변경 버튼
document.getElementById('changeStudentBtn').addEventListener('click', showStudentSelect);
document.getElementById('mobileChangeStudentBtn').addEventListener('click', showStudentSelect);

// ============ 메인 앱 기능 ============

// Navigation
document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        const viewName = link.dataset.view;
        switchView(viewName);
        updateNavStyles(link);
        if (viewName === 'list') loadCardList();
    });
});

function switchView(viewName) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(viewName + 'View').classList.add('active');
}

function updateNavStyles(activeLink) {
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('bg-gradient-to-r', 'from-orange-500/10', 'to-red-500/5', 'dark:from-orange-500/20', 'dark:to-red-500/10', 'text-orange-700', 'dark:text-orange-400', 'border-orange-100', 'dark:border-orange-500/20');
        link.classList.add('text-slate-600', 'dark:text-slate-400', 'border-transparent', 'hover:bg-slate-50', 'dark:hover:bg-slate-800');
    });
    activeLink.classList.remove('text-slate-600', 'dark:text-slate-400', 'border-transparent', 'hover:bg-slate-50', 'dark:hover:bg-slate-800');
    activeLink.classList.add('bg-gradient-to-r', 'from-orange-500/10', 'to-red-500/5', 'dark:from-orange-500/20', 'dark:to-red-500/10', 'text-orange-700', 'dark:text-orange-400', 'border-orange-100', 'dark:border-orange-500/20');
}

updateNavStyles(document.querySelector('.nav-link'));

// Load stats
async function loadStats() {
    if (!currentStudent) return;
    try {
        const res = await fetch(`${API}/api/students/${currentStudent.id}/stats`);
        const stats = await res.json();
        document.getElementById('statTotal').textContent = stats.total;
        document.getElementById('statBox1').textContent = stats.box1;
        document.getElementById('statBox2').textContent = stats.box2;
        document.getElementById('statBox34').textContent = stats.box3 + stats.box4;
    } catch (e) {
        console.error('Stats load failed:', e);
    }
}

// Gacha
document.getElementById('gachaBtn').addEventListener('click', async () => {
    if (!currentStudent) return;
    try {
        const res = await fetch(`${API}/api/students/${currentStudent.id}/cards/random`);
        if (!res.ok) {
            if (res.status === 404) {
                showToast('카드가 없습니다. 먼저 추가해주세요!', true);
                return;
            }
            throw new Error('Failed');
        }
        currentCard = await res.json();
        displayCard(currentCard);
    } catch (e) {
        showToast('카드 뽑기 실패', true);
    }
});

function displayCard(card) {
    document.getElementById('cardQuestion').textContent = card.question;
    document.getElementById('cardAnswer').textContent = card.answer || '(정답 미입력)';
    document.getElementById('boxLabel').textContent = `상자 ${card.box}`;

    const dotColors = ['', 'bg-red-500', 'bg-yellow-500', 'bg-blue-500', 'bg-emerald-500'];
    document.getElementById('boxDot').className = `relative inline-flex rounded-full h-2 w-2 ${dotColors[card.box]}`;

    document.getElementById('answerBox').classList.add('hidden');
    document.getElementById('showAnswerBtn').classList.remove('hidden');
    document.getElementById('feedbackBtns').classList.add('hidden');
}

document.getElementById('showAnswerBtn').addEventListener('click', () => {
    document.getElementById('answerBox').classList.remove('hidden');
    document.getElementById('showAnswerBtn').classList.add('hidden');
    document.getElementById('feedbackBtns').classList.remove('hidden');
});

document.getElementById('successBtn').addEventListener('click', () => submitFeedback(true));
document.getElementById('failBtn').addEventListener('click', () => submitFeedback(false));

async function submitFeedback(success) {
    if (!currentCard) return;
    try {
        await fetch(`${API}/api/cards/${currentCard.id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ success })
        });
        const newBox = success ? Math.min(currentCard.box + 1, 4) : 1;
        showToast(success ? `정답! 상자 ${currentCard.box} → ${newBox}` : '다음에 다시! 상자 1로 이동');

        document.getElementById('cardQuestion').textContent = '카드를 뽑아보세요!';
        document.getElementById('answerBox').classList.add('hidden');
        document.getElementById('showAnswerBtn').classList.add('hidden');
        document.getElementById('feedbackBtns').classList.add('hidden');
        currentCard = null;
        loadStats();
    } catch (e) {
        showToast('저장 실패', true);
    }
}

// Add card
document.getElementById('addCardBtn').addEventListener('click', async () => {
    if (!currentStudent) return;
    const question = document.getElementById('inputQuestion').value.trim();
    const answer = document.getElementById('inputAnswer').value.trim();

    if (!question) {
        showToast('질문을 입력해주세요!', true);
        return;
    }

    try {
        await fetch(`${API}/api/students/${currentStudent.id}/cards`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question, answer })
        });
        showToast('카드가 추가되었습니다!');
        document.getElementById('inputQuestion').value = '';
        document.getElementById('inputAnswer').value = '';
        loadStats();
    } catch (e) {
        showToast('추가 실패', true);
    }
});

// Load card list
async function loadCardList() {
    if (!currentStudent) return;
    const list = document.getElementById('cardList');
    list.innerHTML = '<div class="text-center text-slate-400 py-8 korean-text">로딩 중...</div>';

    try {
        const res = await fetch(`${API}/api/students/${currentStudent.id}/cards`);
        const cards = await res.json();

        if (cards.length === 0) {
            list.innerHTML = '<div class="text-center text-slate-400 py-8 korean-text">카드가 없습니다</div>';
            return;
        }

        const boxBgColors = ['', 'bg-red-100 dark:bg-red-900/20 text-red-600', 'bg-yellow-100 dark:bg-yellow-900/20 text-yellow-600', 'bg-blue-100 dark:bg-blue-900/20 text-blue-600', 'bg-emerald-100 dark:bg-emerald-900/20 text-emerald-600'];

        list.innerHTML = cards.map(card => `
            <div class="flex items-center gap-4 p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-100 dark:border-slate-700">
                <div class="flex-1">
                    <div class="font-bold text-slate-800 dark:text-white korean-text">${escapeHtml(card.question)}</div>
                    <div class="text-sm text-slate-500 korean-text mt-1">정답: ${escapeHtml(card.answer) || '-'}</div>
                </div>
                <span class="px-3 py-1 rounded-lg text-xs font-bold ${boxBgColors[card.box]} korean-text">상자 ${card.box}</span>
                <button class="p-2 text-slate-400 hover:text-red-500 transition-colors" onclick="deleteCard('${card.id}')">
                    <span class="material-symbols-outlined">delete</span>
                </button>
            </div>
        `).join('');
    } catch (e) {
        list.innerHTML = '<div class="text-center text-red-400 py-8 korean-text">로드 실패</div>';
    }
}

async function deleteCard(id) {
    if (!confirm('이 카드를 삭제하시겠습니까?')) return;
    try {
        await fetch(`${API}/api/cards/${id}`, { method: 'DELETE' });
        showToast('삭제되었습니다');
        loadCardList();
        loadStats();
    } catch (e) {
        showToast('삭제 실패', true);
    }
}

function showToast(msg, isError = false) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.remove('opacity-0', 'bg-red-500');
    toast.classList.add('opacity-100');
    if (isError) toast.classList.add('bg-red-500');
    setTimeout(() => {
        toast.classList.remove('opacity-100');
        toast.classList.add('opacity-0');
    }, 2500);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============ 초기화 ============
if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.documentElement.classList.add('dark');
}

// 항상 학생 목록 먼저 로드
loadStudentList();

// 저장된 학생 있으면 자동 선택
const saved = localStorage.getItem('currentStudent');
if (saved) {
    try {
        const student = JSON.parse(saved);
        fetch(`${API}/api/students`)
            .then(res => res.json())
            .then(students => {
                if (students.find(s => s.id === student.id)) {
                    selectStudent(student.id, student.name);
                } else {
                    localStorage.removeItem('currentStudent');
                }
            })
            .catch(() => {});
    } catch {}
}
</script>

</body>
</html>
